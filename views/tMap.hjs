<!DOCTYPE html>
<html>
<head>
    <title>Mapa TEST {{ title }}</title>
    <script src="/javascripts/jquery-2.1.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <link rel="stylesheet" href="/stylesheets/foundation.css" />

	<link rel="stylesheet" href='/stylesheets/font-awesome.min.css'>

    <link rel='stylesheet' href='/stylesheets/style.css' />

    <script src="/javascripts/d3.v3.min.js"></script>
    <script src="/javascripts/topojson.v1.min.js"></script>
    <script src="/javascripts/datamaps.world.min.js"></script>

<script charset="utf-8" src="https://rawgithub.com/artzub/dbsv/master/progressbar.js"></script>
<script charset="utf-8" src="https://rawgithub.com/artzub/dbsv/master/tooltip.js"></script>
<script charset="utf-8" src="https://rawgithub.com/artzub/wbgds/smy/wbc.js"></script>

<style>

    body > div {
        position: absolute;
        overflow: hidden;
    }

    #map {
        left: 0;
        top: 0;
        z-index: 0;
        width: 100%;
        height: 100%;
    }

    #map svg {
        width: 100%;
        height: 100%;
    }

    #map .feature {
        fill : rgba(0,0,0,0.2);
        stroke : rgba(0,0,0,0.2);
    }

    #c {
        left: 0;
        top: 0;
        z-index: 1;
    }

    #s {
        left: 0;
        top: 0;
        z-index: 2;
    }

    .gtLeg, .gttLeg {
        fill : #f9f9f9;
        text-shadow: 0 1px 2px rgba(0, 0, 0, .5);
    }

    .com-mess {
        font-size: 11pt;
        font-family: Verdana,serif;
        fill: #ffffff;
        fill-opacity: .3;
    }

    #pb {
        left: 0;
        bottom: 0;
        position: fixed;
        z-index: 100;
        height: auto;
        font-size: 10px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, .8);
    }
</style>

<!-- <div id="menu">
    <ul>
        <li>
            <button id="btnRestart" class="btn" style="display: none">↷ Restart</button>
            <button id="btnStart" class="btn" style="display: none">► Play</button>
            <button id="btnPause" class="btn">▌▌Pause</button>
            <button id="btnStop" class="btn">█▌Stop</button>
        </li>
        <li>
            <label for="typeParam">Coloring by:</label>
            <select name="typeParam" id="typeParam"></select>
        </li>
        <li>
            <label for="fiscalYear">Fiscal year:</label>
            <select name="fiscalYear" id="fiscalYear"></select>
            <button id="btnReload" class="btn" style="display: none">⇒ Reload</button>
            <img id="imgPreloader" alt="" style="margin: 5px 5px -5px 0; display: none;" src="data:image/gif;base64,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" />
        </li>
    </ul>
</div> -->

<div id="info">
<!--     <ul>
        <li>Options
            <ul>
                <li>
                    <input id="chHisto" type="checkbox" checked="checked">
                    <label for="chHisto">Show histogram</label>
                </li>
                <li>
                    <input id="chLeg" type="checkbox" checked="checked">
                    <label for="chLeg">Show legend</label>
                </li>
                <li>
                    <input id="chEdge" type="checkbox">
                    <label for="chEdge">Show all edges</label>
                </li>
                <li>
                    <input id="chTrack" type="checkbox" checked="checked">
                    <label for="chTrack">Show tracks</label>
                </li>
                <li>
                    <input id="chTail" type="checkbox" checked="checked">
                    <label for="chTail">Fading tail</label>
                </li>
            </ul>
        </li>
        <li>Info
            <ul>
                <li>
                    <strong>WorldBank Contract Awards</strong>
                    <hr>
                    <div>
                        We’re using the World Bank’s Major Contract Awards dataset,<br/>
                        which serves as a guide on the distribution of major contract<br/>
                        commitments among the Bank’s member countries.
                    </div>
                </li>
                <li style="background: rgba(0, 0, 0, .1); border: 1px dotted rgba(0, 0, 0, .3)">
                    <strong>What's going on</strong>
                    <ol style="color: #d9d9d9;">
                        <li>• Each luminous particle is a contract. It moves from supplier to borrower.</li>
                        <li>• The size of particle depends of contract amount.</li>
                        <li>• Each node of country gathers contracts which it borrowed.</li>
                        <li>• Every second is a day.</li>
                        <li>• The histogram shows the number of contracts per day, separated by a selected criterion.</li>
                        <li>• The legend shows the number of contracts for all time separated by a selected criterion.</li>
                    </ol>
                </li>
                <li style="background: rgba(0, 0, 0, .2); border: 1px dotted rgba(0, 0, 0, .6)">
                    <strong>How to use:</strong>
                    <ol style="color: #d9d9d9;">
                        <li>• Uses buttons for controlling process visualization.</li>
                        <li>• Uses select for choosing fiscal year or criteria of colouring.</li>
                        <li>• Uses mouse wheel for zooming.</li>
                        <li>• Uses mouse cursor for showing information about focused node.</li>
                    </ol>
                </li>
                <li>
                    <small>© 2013 Created by <a href="http://artzub.com" title="Artem Zubkov">Artem Zubkov</a> (<a href="https://github.com/artzub/wbgds">GitHub</a>).<br/>
                    Powered by <a href="http://d3js.org" title="D3js">D3.js</a>. Icons flags — <a href="http://forum.tsgk.com/viewtopic.php?t=4921">Country Code & Territories Flags Pack Icons</a></small>
                </li>
            </ul>
        </li>
        <li><a href="#" title="Open in a new window" id="fs">fullscreen</a></li>
    </ul> -->
</div>

<script>
"use strict";

(function(window) {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame =
                window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
    }

    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); },
                    timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };

    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
})(window);

var vis = {},
    cat = 'Major Sector'
    ;

var setting = {
    childLife : 5 // number of steps of life a child
    , parentLife : 5 // number of steps of life a parent
    , showCountExt : false // show table of child's extension
    , onlyShownExt : false // show only extension which is shown
    , showHistogram : false // displaying histogram of changed files
    , showHalo : true // show a child's halo
    , padding : 0 // padding around a parent
    , rateOpacity : .5 // rate of decrease of opacity
    , rateFlash : 2.5 // rate of decrease of flash
    , sizeChild : 2 // size of child
    , sizeParent : 5 // size of parent
    , showPaddingCircle : false // show circle of padding
    , useImage : true // show base's image
    , showChild : true // show a child
    , showParent : false // show a parent
    , showLabel : false // show base name
    , showMessage : false // show commit message
    , skipEmptyDate : true // skip empty date
    , blendingLighter : true
    , showTrack : true // show tracks
    , showEdge : false // show an edge
    , groupByRegion : false
    , fadingTail : true
};

var asyncForEach = function(items, fn, time) {
    if (!(items instanceof Array))
        return;

    var workArr = items.reverse().concat();

    function loop() {
        if (workArr.length > 0)
            fn(workArr.shift(), workArr);
        if (workArr.length > 0)
            setTimeout(loop, time || 1);
    }
    loop();
};

var shortTimeFormat = (function() {
    var fd = d3.time.format("%d.%b.%y");
    return function(ms) {
        return fd(new Date(ms/* - TIME_ZONE*/));
    }
})();

var ONE_SECOND = 1000,
    stepDate = 24 * 60 * 60 * 1000
;

(function(vis) {
    /*var ONE_SECOND = 1000,
     stepDate = 24 * 60 * 60 * 1000
     ;*/

    var PI_CIRCLE = Math.PI * 2;

    var _worker,
        _data,
        nodes,
        dateRange,
        selected,
        selectedExt,

        colorless = d3.rgb("gray"),
        colorlessFlash = d3.rgb("lightgray"),

        parentHash,
        childHash,
        extHash,
        extMax,

        _parentKey,
        _childKey,

        _force,
        _forceBase,

        links,
        regionLinks,

        lCom, lLeg, lHis,

        canvas, ctx,
        bufCanvas, bufCtx,
        layer,

        valid,
        pause,
        stop,

        particle,

        lastEvent,
        zoomScale,
        _w, _h,
        xW,
        yH,

        setting,
        rd3 = d3.random.irwinHall(8)
    ;

    var extColor = d3.scale.category20(),
        baseColor = d3.scale.category20b()
    ;

    var th = d3.format(",");

    var typeNode = {
        parent : 0,
        child : 1,
        region : 2
    };

    particle = new Image();
    particle.src = "data:image/png;base64,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";


    function reCalc(d) {
        if (stop)
            return;

        lCom.showMessage(d.supplier.shortName + ' to ' + d.borrower.shortName + ' -> ' + d.project.name);

        var l = d.nodes.length,
                n, a, fn;

        a = d.parentNode;
        a.relations = a.relations || {};
        a.fixed = a.x instanceof Object || a.y instanceof Object ? true : false;

        if (!l)
            console.log(d);
        else {
            a.alive = setting.parentLife > 0 ? setting.parentLife : 1;
            a.opacity = 100;
            a.flash = 100;
            a.visible = true;
        }

        while(--l > -1) {
            n = d.nodes[l];

            if (n.fixed) {
                //n.x = xW(n.x);
                //n.y = yH(n.y);
                n.x = a.x;
                n.y = a.y;
                n.paths = [{x : n.x, y : n.y}];
                n.msize = n.size;
                n.size *= 3;
            }
            else {
                n.size = n.hasOwnProperty("msize") ? n.msize : n.size;
                delete n["msize"];
            }

            //n.size += 2;
            n.fixed = false;

            n.parent = a;

            n.visible = true;
            fn = _childKey(n.nodeValue);

            n.flash = 100;
            n.opacity = 100;
            n.alive = setting.childLife > 0 ? setting.childLife : 1;

            if (n.visible) {
                n.ext.now.indexOf(fn) < 0
                && n.ext.now.push(fn);
            }
            else {
                (fn = n.ext.now.indexOf(fn)) > -1
                && n.ext.now.splice(parseInt(fn), 1);

                n.flash *= .5;
                n.alive *= .2;
                n.opacity *= .5;
            }

            var key = a.id + "_" + n.id,
                src = a,
                trg = n,
                bid = _parentKey(n.nodeValue.borrower),
                sid = _parentKey(n.nodeValue.supplier)

            ;

            if (a.id != bid && !a.relations.hasOwnProperty(bid)) {
                a.relations[bid] = n.nodeValue.borrower;
            } else if (a.id != sid && !a.relations.hasOwnProperty(sid)) {
                a.relations[sid] = n.nodeValue.supplier;
            }

            if (n.nodeValue.borrower == a.nodeValue) {
                key = n.id + "_" + a.id;
                src = n;
                trg = a;
            }

            if (!links.has(key))
                links.set(key, {
                    key : key,
                    source : src,
                    target : trg
                });

            if (n.nodeValue.supplier == n.nodeValue.borrower) {
                key = n.id + "_" + a.id;
                if (!links.has(key))
                    links.set(key, {
                        key : key,
                        source : trg,
                        target : src
                    });
            }
        }

        updateLegend(/*d.sha*/);

        _force.nodes(nodes.filter(function(d) {
            return d.type != typeNode.parent && (d.visible || d.opacity);
        })//.sort(sortBySize)
        ).start();

        _forceBase.nodes(nodes.filter(function(d) {
            if (d.type == typeNode.region) {
                d.alive = 1;
                d.opacity = 100;
                d.flash = 100;
            }
            return (d.type == typeNode.parent || (setting.groupByRegion && d.type == typeNode.region)) && (d.visible || d.opacity);
        })).start();
    }

    function loop() {

        if (stop) {
            clearTimeout(_worker);
            return;
        }

        if (pause) {
            clearTimeout(_worker);
            _worker = setTimeout(loop, ONE_SECOND);
            return;
        }

        var dl, dr;

        dl = dateRange[0];
        dr = dl + stepDate;
        dateRange[0] = dr;

        appendExtLegend(shortTimeFormat(dr));

        var visTurn = _data.filter(function (d) {
            return d.date >= dl && d.date < dr;
        });

        asyncForEach(visTurn, reCalc, ONE_SECOND / (visTurn.length > 1 ? visTurn.length : ONE_SECOND));

        vis.pb.step(stepDate).label(shortTimeFormat(dr));

        if (dl >= dateRange[1]) {
            if (typeof _worker !== "undefined") {
                updateExtHistogram();
                clearTimeout(_worker);
                return;
            }
        } else {
            if (!visTurn.length && setting.skipEmptyDate)
                loop();
        }

        updateExtHistogram();
        _worker = setTimeout(loop, ONE_SECOND);
    }

    function run() {
        if (typeof _worker !== "undefined")
            clearTimeout(_worker);

        render();

        _worker = setTimeout(loop, ONE_SECOND);
    }

    function nr(d) {
        return d.size > 0 ? d.size : 0;
    }

    function curColor(d) {
        var ext = selectedExt;

        if (!ext && selected) {
            if (selected.type == typeNode.parent) {
                return d.nodeValue.borrower !== selected.nodeValue
                    && d.nodeValue.supplier !== selected.nodeValue
                    ? d.flash ? colorlessFlash : colorless
                    : d.flash ? d.flashColor : d.d3color;
            }
            if (selected.ext)
                ext = selected.ext;
        }

        return ext && ext.color && ext.color !== d.d3color
            ? d.flash ? colorlessFlash : colorless
            : d.flash ? d.flashColor : d.d3color;
    }

    function curOpacityParent(d) {
        if (selected && selected.type == typeNode.parent) {
            return selected != d && !selected.relations[_parentKey(d.nodeValue)]
                ? 20 : d.opacity;
        }

        return selected && selected.type == typeNode.child
            && selected.nodeValue.borrower !== d.nodeValue
            && selected.nodeValue.supplier !== d.nodeValue
            ? 20 : d.opacity;
    }

    function curOpacity(d) {
        if (d.type == typeNode.parent)
            return curOpacityParent(d);

        var ext = selectedExt;

        if (!ext && selected) {
            if (selected.type == typeNode.parent) {
                return d.nodeValue.borrower !== selected.nodeValue
                        && d.nodeValue.supplier !== selected.nodeValue
                        ? 20 : d.opacity;
            }
            if (selected.ext)
                ext = selected.ext;
        }

        return ext && ext.color && ext.color !== d.d3color
                ? 20 : d.opacity;
    }

    function randomTrue() {
        return Math.floor(rd3() * 8) % 2;
    }

    function radius(d) {
        return Math.sqrt(d);
    }

    function contain(d, pos) {
        var px = (lastEvent.translate[0] - pos[0]) / lastEvent.scale,
            py = (lastEvent.translate[1] - pos[1]) / lastEvent.scale,
            r = Math.sqrt( Math.pow( d.x + px , 2) +
                    Math.pow( d.y + py , 2 ) );

        return r < (d.type == typeNode.parent ? nr(d) * 1.5 : radius(nr(d)));
    }

    function getNodeFromPos(pos) {
        for (var i = nodes.length - 1; i >= 0; i--) {
            var d = nodes[i];
            if (d.visible && contain(d, pos))
                return d;
        }
        return null;
    }

    function node(d, type) {
        var c = type == typeNode.child ? d[cat] : baseColor(d.key),
            ext, x, y,
            w2 = _w/2,
            w5 = _w/5,
            h2 = _h/2,
            h5 = _h/5
        ;
        if (type == typeNode.child) {
            ext = extHash.get(c);
            if (!ext) {
                ext = {
                    all : 0,
                    currents : {},
                    values : {},
                    color : d3.rgb(extColor(c)),
                    now : []
                };
                extHash.set(c, ext);
            }
            ext.all++;
            c = ext.color;
        }

        x = _w * Math.random();
        y = _h * Math.random();

        if (type == typeNode.parent || type == typeNode.region) {
            if (randomTrue()) {
                x = x > w5 && x < w2
                    ? x / 5
                    : x > w2 && x < _w - w5
                    ? _w - x / 5
                    : x
                ;
            }
            else {
                y = y > h5 && y < h2
                    ? y / 5
                    : y > h2 && y < _h - h5
                    ? _h - y / 5
                    : y
                ;
            }
            if (type == typeNode.parent) {
                if (d.hasOwnProperty("x")) {
                    x = d.x;
                }
                if (d.hasOwnProperty("y")) {
                    y = d.y;
                }
            }
        }

        return {
            x : x,
            y : y,
            id : type + (type == typeNode.child ? _childKey(d) : type == typeNode.region ? d : _parentKey(d)),
            size : type != typeNode.child ? type == typeNode.parent ? setting.sizeParent : 50 : d.size || 2,
            weight : type != typeNode.child ? 24 : d.size || 2,
            fixed : true,
            visible : type == typeNode.region,
            links : 0,
            type : type,
            color : c.toString(),
            d3color : c,
            flashColor: type == typeNode.child ? c.brighter().brighter() : c,
            ext : ext,
            parent : type == typeNode.parent ? d.key : null,
            img : type == typeNode.parent ? d.img : null,
            nodeValue : d
        }
    }

    function getBase(d) {
        if (!d || !d.parent)
            return null;

        var pkey = _parentKey(d.parent);

        var n = parentHash.get(pkey);

        if (!n) {
            n = node(d.parent, typeNode.parent);
            parentHash.set(pkey, n);
        }
        return n;
    }

    function getChild(d) {
        if (!d)
            return null;

        var key = _childKey(d);

        var n = childHash.get(key);

        if (!n) {
            n = node(d, typeNode.child);
            n.links = 1;
            childHash.set(key, n);
        }
        return n;
    }

    function initNodes(data) {
        var ns = [],
                i, j, n, d, df;
        parentHash = d3.map({});
        childHash = d3.map({});
        extHash = d3.map({});
        extMax = 0;

        if (data) {
            i = data.length;
            while(--i > -1) {
                d = data[i];
                if (!d) continue;
                d.nodes = [];

                n = getBase(d);
                d.parentNode = n;
                !n.inserted && (n.inserted = ns.push(n));

                if (!d.parent.borrowed && !n.region) {
                    if (!parentHash.has("suppliers"))
                        parentHash.set("suppliers", node("suppliers", typeNode.region));
                    n.region = parentHash.get("suppliers");
                }
                else {
                    if (!parentHash.has(d.Region))
                        parentHash.set(d.Region, node(d.Region, typeNode.region));
                    n.region = parentHash.get(d.Region);
                }

                n = getChild(d);
                d.nodes.push(n);
                n.ext.currents[shortTimeFormat(d.date)] = (n.ext.currents[shortTimeFormat(d.date)] || 0);
                n.ext.currents[shortTimeFormat(d.date)]++;
                n.ext.values['_' + d.id] = +d;
                !n.inserted && (n.inserted = ns.push(n));

                j = extHash.values().reduce((function(id) { return function(a, b) {
                    return (a || 0) + (b.currents[id] || 0);
                }})(shortTimeFormat(d.date)), null);

                extMax = j > extMax ? j : extMax;
            }
        }
        return ns;
    }

    var tempFileCanvas;
    function colorize(img, r, g, b, a) {
        if (!img)
            return img;

        if (!tempFileCanvas)
            tempFileCanvas = document.createElement("canvas");

        if (tempFileCanvas.width != img.width)
            tempFileCanvas.width = img.width;

        if (tempFileCanvas.height != img.height)
            tempFileCanvas.height = img.height;

        var imgCtx = tempFileCanvas.getContext("2d"),
                imgData, i;
        imgCtx.drawImage(img, 0, 0);

        imgData = imgCtx.getImageData(0, 0, img.width, img.height);

        i = imgData.data.length;
        while((i -= 4) > -1) {
            imgData.data[i + 3] = imgData.data[i] * a;
            if (imgData.data[i + 3]) {
                imgData.data[i] = r;
                imgData.data[i + 1] = g;
                imgData.data[i + 2] = b;
            }
        }

        imgCtx.putImageData(imgData, 0, 0);
        return tempFileCanvas;
    }

    function blink(d, aliveCheck) {
        d.flash = (d.flash -= setting.rateFlash) > 0 ? d.flash : 0;

        !d.flash && aliveCheck
        && (d.alive = (d.alive-- > 0 ? d.alive : 0))
        ;

        d.opacity = !d.alive
                ? ((d.opacity -= setting.rateOpacity) > 0 ? d.opacity : 0)
                : d.opacity
        ;

        d.visible && !d.opacity
        && (d.visible = false);

        if (d.paths) {
            d.pathLife = (d.pathLife || 0);
            if (d.pathLife++ > 0) {
                d.pathLife = 0;
                if (d.paths.length)
                    d.paths.shift();
            }
        }
    }

    function sortBySize(a, b) {
        return d3.ascending(a.size, b.size);
    }

    function checkVisible(d, offsetx, offsety) {
        var tx = lastEvent.translate[0]/lastEvent.scale,
                ty = lastEvent.translate[1]/lastEvent.scale
                ;

        offsetx = offsetx || 0;
        if (!(offsetx instanceof Array))
            offsetx = [offsetx, offsetx];
        offsety = offsety || 0;
        if (!(offsety instanceof Array))
            offsety = [offsety, offsety];

        return (
                d.x + d.size > -tx + offsetx[0]
                        && d.x - d.size < -tx + offsetx[1] + _w/lastEvent.scale
                        && d.y + d.size > -ty + offsety[0]
                        && d.y - d.size < -ty + offsety[1] + _h/lastEvent.scale
                );
    }

    function sortByColor(a, b) {
        return d3.ascending(b.color + !b.flash, a.color + !a.flash);
    }

    function sortByOpacity(a, b) {
        return d3.ascending(curOpacity(b), curOpacity(a));
    }

    function compereColor(a, b) {
        return a.r != b.r || a.g != b.g || a.b != b.b;
    }

    function filterVisible(d) {
        return checkVisible(d) && (d.visible || d.alive);
    }

    function redrawCanvas() {

        bufCtx.save();
        bufCtx.clearRect(0, 0, _w, _h);

        if (setting.blendingLighter && bufCtx.globalCompositeOperation == 'source-over') {
            bufCtx.globalCompositeOperation = 'lighter';
            //darker
        }
        else if (!setting.blendingLighter && bufCtx.globalCompositeOperation == 'lighter') {
            bufCtx.globalCompositeOperation = 'source-over';
        }

        bufCtx.translate(lastEvent.translate[0], lastEvent.translate[1]);
        bufCtx.scale(lastEvent.scale, lastEvent.scale);

        var n, l, i, j,
            src, trg,
            iw, ih,
            img,
            d, beg,
            c, x, y, s;


        if (setting.showEdge || selected){
            n = links.entries();
            if (!setting.showEdge)
                n = n.filter(function(d) {
                    return d.key.indexOf(selected.id) >= 0;
                });

            l = n.length;

            bufCtx.save();
            bufCtx.lineCap="round";
            bufCtx.lineJoin="round";

            while(--l > -1) {
                d = n[l].value;
                src = d.source;
                trg = d.target;
                j = src.type == typeNode.child;

                c = curColor(j ? src : trg);

                bufCtx.beginPath();
                bufCtx.strokeStyle = c.toString();
                bufCtx.lineWidth = (radius(nr(d)) * 3)  || 1;

                var sx = j ? trg.x : src.x,
                    sy = j ? trg.y : src.y,
                    tx = !j ? trg.x : src.x,
                    ty = !j ? trg.y : src.y;

                bufCtx.moveTo(sx, sy);
                var x3 = .3 * ty - .3 * sy + .8 * sx + .2 * tx,
                    y3 = .8 * sy + .2 * ty - .3 * tx + .3 * sx,
                    x4 = .3 * ty - .3 * sy + .2 * sx + .8 * tx,
                    y4 = .2 * sy + .8 * ty - .3 * tx + .3 * sx;
                bufCtx.bezierCurveTo(x3, y3, x4, y4, tx, ty);
                bufCtx.stroke();
            }
            bufCtx.restore();
        }

        if (setting.showChild) {
            n = _force.nodes()
                    .filter(filterVisible)
                    .sort(sortBySize)
                    .sort(sortByOpacity)
                    .sort(sortByColor)
            ;

            l = n.length;

            c = null;
            i = 100;
            j = true;
            beg = false;

            bufCtx.globalAlpha = i * .01;

            while(--l > -1) {
                d = n[l];

                if (i != curOpacity(d)) {
                    i = curOpacity(d);
                    bufCtx.globalAlpha = i * .01;
                }

                if (!c || compereColor(c, curColor(d))) {
                    c = curColor(d);
                    j = false;
                }

                if (!j) {
                    if (!setting.showHalo) {
                        if (beg) {
                            bufCtx.closePath();
                            bufCtx.fill();
                            bufCtx.stroke();
                        }

                        bufCtx.beginPath();
                        beg = true;
                        bufCtx.strokeStyle = "none";
                        bufCtx.fillStyle = c.toString();
                    }
                    else
                        img = colorize(particle, c.r, c.g, c.b, 1);
                    j = true;
                }

                x = Math.floor(d.x);
                y = Math.floor(d.y);


                if (setting.fadingTail && setting.showTrack) {
                    //bufCtx.save();
                    bufCtx.lineCap="round";
                    //bufCtx.lineJoin="round";
                    bufCtx.lineWidth = (radius(nr(d)) / 4)  || 1;
                    bufCtx.fillStyle = "none";
                    bufCtx.strokeStyle = c.toString();

                    var rs = d.paths.slice(0).reverse(),
                        lrs = rs.length,
                        cura = bufCtx.globalAlpha;

                    for (var p in rs) {
                        if (!rs.hasOwnProperty(p))
                            continue;

                        bufCtx.beginPath();
                        if (p < 1)
                            bufCtx.moveTo(x, y);
                        else
                            bufCtx.moveTo(
                                Math.floor(rs[p - 1].x),
                                Math.floor(rs[p - 1].y)
                            );
                        bufCtx.lineTo(
                            Math.floor(rs[p].x),
                            Math.floor(rs[p].y)
                        );
                        //bufCtx.closePath();
                        bufCtx.stroke();
                        bufCtx.globalAlpha = ((lrs - p)/lrs) * cura;
                        //bufCtx.strokeStyle = "rgba(" + [c.r, c.g, c.b, (lrs - p)/lrs ] + ")";                        
                    }
                    //bufCtx.restore();
                    bufCtx.globalAlpha = cura;
                }

                if (!setting.fadingTail && setting.showTrack) {
                    bufCtx.save();
                    bufCtx.beginPath();
                    bufCtx.lineCap="round";
                    bufCtx.lineJoin="round";
                    bufCtx.strokeStyle = c.toString();
                    bufCtx.lineWidth = (radius(nr(d)) / 4)  || 1;

                    var rs = d.paths.slice(0).reverse(),
                        lrs = rs.length;

                    bufCtx.moveTo(x, y);
                    for (var p in rs) {
                        if (!rs.hasOwnProperty(p))
                            continue;

                        bufCtx.lineTo(
                                Math.floor(rs[p].x),
                                Math.floor(rs[p].y)
                        );
                    }
                    //bufCtx.closePath();
                    bufCtx.stroke();
                    bufCtx.restore();
                }

                s = radius(nr(d)) * (setting.showHalo ? 8 : 1);
                setting.showHalo
                        ? bufCtx.drawImage(img, x - s / 2, y - s / 2, s, s)
                        : bufCtx.arc(x, y, s, 0, PI_CIRCLE, true)
                ;
            }
            if (!setting.showHalo && beg) {
                bufCtx.closePath();
                bufCtx.fill();
                bufCtx.stroke();
            }
        }

        if (setting.showParent || setting.showLabel) {
            n = _forceBase.nodes().filter(filterVisible).sort(sortByOpacity);
            l = n.length;

            i = 100;

            bufCtx.globalAlpha = i * .01;

            while(--l > -1) {
                d = n[l];

                if (i != curOpacity(d)) {
                    i = curOpacity(d);
                    bufCtx.globalAlpha = i * .01;
                }

                x = Math.floor(d.x);
                y = Math.floor(d.y);

                if (setting.showParent) {
                    c = curColor(d);
                    bufCtx.save();

                    if (setting.showPaddingCircle) {
                        bufCtx.beginPath();
                        bufCtx.strokeStyle = "none";
                        bufCtx.fillStyle = "#ff0000";
                        bufCtx.arc(x, y, nr(d) + setting.padding, 0, PI_CIRCLE, true);
                        bufCtx.closePath();
                        bufCtx.fill();
                        bufCtx.stroke();
                    }

                    bufCtx.beginPath();
                    bufCtx.strokeStyle = "transparent";
                    bufCtx.fillStyle = setting.useImage ? "transparent" : c;
                    bufCtx.arc(x, y, nr(d), 0, PI_CIRCLE, true);
                    bufCtx.closePath();
                    bufCtx.fill();
                    bufCtx.stroke();
                    // img = d.img && d.img.width > 0 && d.img.height > 0 ? d.img : defImg;
                    if (setting.useImage && img.width > 0 && img.height > 0) {
                        bufCtx.clip();
                        iw = img.width;
                        ih = img.height;

                        if (iw == ih) {
                            ih = iw = nr(d);
                        }
                        else if (iw > ih) {
                            ih = (ih/iw) * nr(d) * 1.2;
                            iw = nr(d) * 1.2;
                        }
                        else {
                            iw = (iw/ih) * nr(d) * 1.2;
                            ih = nr(d) * 1.2;
                        }


                        bufCtx.drawImage(img, x - iw, y - ih, iw * 2, ih * 2);
                    }

                    bufCtx.restore();
                }

                if (setting.showLabel) {
                    c = d.flash ? "white" : "gray";

                    bufCtx.fillStyle = c;
                    bufCtx.fillText(d.nodeValue.shortName, x, y + nr(d) * 1.5);
                }
            }
        }
        bufCtx.restore();
    }

    function render() {
        requestAnimationFrame(render);

        lHis && lHis.style("display", setting.showHistogram ? null : "none");
        lLeg && lLeg.style("display", setting.showCountExt ? null : "none");

        if (valid)
            return;

        valid = true;

        ctx.save();
        ctx.clearRect(0, 0, _w, _h);

        redrawCanvas();

        ctx.drawImage(bufCanvas, 0, 0);
        ctx.restore();

        valid = false;
    }

    function tick() {
        if (_force.nodes()) {

            if (setting.groupByRegion)
                _forceBase
                    .friction(.75)
                    .gravity(0)
                    .nodes()
                    .forEach(clusterParent(0.025));
            else
                _forceBase
                    .friction(.9)
                    .gravity(setting.padding * .001);

            _force.nodes()
                .forEach(cluster(0.025));

            _forceBase.nodes(
                _forceBase.nodes()
                    .filter(function(d) {
                        blink(d, !d.links && setting.parentLife > 0);
                        if (d.visible && d.links === 0 && setting.parentLife > 0) {
                            d.flash = 0;
                            d.alive = d.alive / 10;
                        }
                        return d.visible;
                    })
            );
            if (setting.groupByRegion)
                _forceBase.links(regionLinks);
        }

        _forceBase.resume();
        _force.resume();
    }

    // Move d to be adjacent to the cluster node.
    function cluster(alpha) {

        parentHash.forEach(function(k, d) {
            d.links = 0;
        });

        return function(d) {
            blink(d, setting.childLife > 0);
            if (!d.parent || !d.visible)
                return;

            var node = d.parent,
                l,
                r,
                x,
                y;

            if (node == d) return;
            node.links++;

            x = d.x - node.x;
            y = d.y - node.y;
            l = Math.sqrt(x * x + y * y);
            r = radius(nr(d)) / 2 + (nr(node) + setting.padding);
            if (l != r) {
                l = (l - r) / (l || 1) * (alpha || 1);
                x *= l;
                y *= l;

                d.x -= x;
                d.y -= y;
            }
            d.paths && (d.flash/* || d.paths.length > 2*/) && d.paths.push({
                x : d.x,
                y : d.y
            });
        };
    }

    function clusterParent(alpha) {

        return function(d) {
            if (!d.region || !d.visible)
                return;

            var node = d.region,
                    l,
                    r,
                    x,
                    y;

            if (node == d) return;
            node.links++;

            x = d.x - node.x;
            y = d.y - node.y;
            l = Math.sqrt(x * x + y * y);
            r = nr(d) + (nr(node) + setting.padding * 2);
            if (l != r) {
                l = (l - r) / (l || 1) * (alpha || 1);
                x *= l;
                y *= l;

                d.x -= x;
                d.y -= y;
            }
        };
    }

    function appendExtLegend(key){
        if (!layer)
            return;

        var data = [],
            w3 = _w / 3,
            ml = 5,//_w * .01,
            mb = 18,
            h2 = (_h / 2) - mb,
            bw = 2,
            ny
            ;

        var y = d3.scale.linear()
            .range([0, h2])
            .domain([0, extMax]);

        lHis = (lHis || layer.insert("g", ":first-child"))
            .attr("width", w3)
            .attr("height", h2)
            .attr("transform", "translate(" + [ ml , _h - h2 - mb ] + ")");

        if (!key)
            return;

        ny = h2;
        extHash.forEach(function(k, d) {
            var obj = {
                key : k,
                h : y(d.currents[key] || 0),
                color : d.color
            };
            obj.y = ny -= obj.h;
            data.push(obj);
        });

        updateExtHistogram();

        var g = lHis.append("g")
            .attr("class", "colStack")
            .datum({ x : 0, max : w3, w : bw })
            .style("opacity", 0);

        g.selectAll("rect")
            .data(data)
            .enter()
            .append("rect")
            .attr("x", 0)
            .attr("y", function(d) {  return d.y;  })
            .attr("width", bw)
            .attr("height", function(d) { return d.h; })
            .attr("fill", function(d) { return d.color; })
        ;

        g.style("opacity", 1)
            .attr("transform", function(d) {
                return "translate(" + [ d.x, 0] + ")";
            });
    }

    function updateExtHistogram() {
        if (!lHis || lHis.selectAll(".colStack").empty())
            return;

        lHis.selectAll(".colStack")
            .attr("transform", function(d) {
                return "translate(" + [ d.x += d.w/2, 0] + ")";
            })
            .filter(function(d) {
                return d.x > d.max;
            })
            .remove()
        ;
    }

    function lme(d) {
        selectedExt = d.value;

        tooltip.html([
            "<b style='text-shadow: 1px 1px 1px #000; color:",
            d.value.color,
            "'>", d.key, "</b>",
            "<hr>",
            "Number of contract: <b>",
            d.value.now.length,
            "</b><br/>Money ($): <b>",
            th(d3.sum(d3.values(d.value.values))),
            "M.</b><br/>"
        ].join(''));
        tooltip.style("display", "block");
        updateLegend();
    }

    function lml() {
        selectedExt = null;
        tooltip.style("display", null);
        updateLegend();
    }

    function lmm(d) {
        moveToolTip(d, d3.event);
    }

    function legColor(d) {
        var ext = selectedExt;
        if (!ext && selected
            && selected.type == typeNode.child
            && selected.ext)
            ext = selected.ext;

        return ext
                ? ext == d.value
                    ? d.value.color
                    : colorless
                : d.value.color;
    }

    function initLegend() {
        if (!layer)
            return;

        var mt = 48,
            ml = 5,//_w * .01,
            h2 = _h / 2 - mt,
            w3 = _w / 3
            ;

        lLeg = (lLeg || layer.append("g"))
            .attr("width", w3)
            .attr("height", h2)
            .attr("transform", "translate(" + [ml, mt] + ")");

        lLeg.selectAll("*").remove();

        var g = lLeg.selectAll(".gLeg")
            .data(extHash.entries(), function(d) { return d.key; });

        g.exit().remove();

        g.enter().append("g")
            .on("mouseover", lme)
            .on("mousemove", lmm)
            .on("mouseout", lml)
            .attr("class", "gLeg")
            .attr("transform", function(d, i) {
                return "translate(" + [0, i * 18] + ")";
            })
            .style("visibility", "hidden")
        ;
        g.append("rect")
            .attr("height", 16)
            .style("fill", legColor)
        ;
        g.append("text")
            .attr("class", "gttLeg")
            .style("font-size", "13px")
            .text(function(d) { return d.key; })
            .style("fill", function(d) { return d3.rgb(d.value.color).brighter().brighter(); })
        ;

        g.append("text")
            .attr("class", "gtLeg")
            .style("font-size", "11px")
            .attr("transform", "translate(" + [2, 12] + ")")
        ;
    }

    function sortLeg(b, a) {
        return d3.ascending(a.value.now.length, b.value.now.length);
    }

    function sortLegK(b, a) {
        return d3.ascending(a.key, b.key);
    }

    function updateLegend() {
        if (!lLeg || lLeg.empty())
            return;

        var g = lLeg.selectAll(".gLeg");

        function wl(d) {
            return d.value.now.length;
        }

        g.selectAll(".gtLeg")
            .text(wl)
        ;

        var wb = d3.max(g.selectAll(".gtLeg"), function(d) {
            return d[0].clientWidth || d[0].getComputedTextLength();
        }) + 4;

        g.selectAll("rect")
            .style("fill", legColor)
            .attr("width", wb)
        ;

        g.selectAll(".gttLeg")
            .attr("transform", "translate(" + [wb + 2, 12] + ")")
        ;

        g.sort(sortLegK).sort(sortLeg)
            .style("visibility", function(d, i) {
                return !wl(d) || i * 18 > lLeg.attr("height") ? "hidden" : "visible";
            })
            //.transition()
            //.duration(500)
            .attr("transform", function(d, i) {
                return "translate(" + [0, i * 18] + ")";
            })
        ;

    }

    var tooltip;

    function showToolTip(d) {
        var res;
        if (!d) {
            tooltip.style("display", "none");
            return;
        }
        if (tooltip.style("display") == "none") {
            res = [];

            if (d.type == typeNode.parent) {
                res = [
                    d.img && d.img.width > 0 && d.img.height > 0 ? d.img.outerHTML : "",
                    " Country: <b>",
                    d.nodeValue.shortName,
                    "</b><hr/>Supplied ($): <b>",
                    th(d.nodeValue.supplied),
                    "M.</b><br/>Borrowed ($): <b>",
                    th(d.nodeValue.borrowed),
                    "M.</b><br/>"
                ];
            }
            else {
                res = [
                    "Contract: <b>",
                    d.nodeValue.contract.desc,
                    "</b><br/>Date: <b>",
                    shortTimeFormat(d.nodeValue.contract.date),
                    "</b><hr/>Project: <b>",
                    "(", d.nodeValue.project.id, ") ",
                    d.nodeValue.project.name,
                    "</b><br/>Product line: <b",
                    cat == "Product line" ? ' style="text-shadow: 0 0 2px rgba(0, 0, 0, .8);color:' + extColor(d.nodeValue[cat]) + '"' : "",
                    ">",
                    d.nodeValue.product,
                    "</b><br/>Major Sector: <b",
                    cat == "Major Sector" ? ' style="text-shadow: 0 0 2px rgba(0, 0, 0, .8);color:' + extColor(d.nodeValue[cat]) + '"' : "",
                    ">",
                    d.nodeValue.sector,
                    "</b><hr/>Procurement: <b>",
                    "</b><br/>• Type: <b",
                    cat == "Procurement Type" ? ' style="text-shadow: 0 0 2px rgba(0, 0, 0, .8);color:' + extColor(d.nodeValue[cat]) + '"' : "",
                    ">",
                    d.nodeValue.procurement.type,
                    "</b><br/>• Method: <b",
                    cat == "Procurement Method" ? ' style="text-shadow: 0 0 2px rgba(0, 0, 0, .8);color:' + extColor(d.nodeValue[cat]) + '"' : "",
                    ">",
                    d.nodeValue.procurement.method,
                    "</b><br/>• Category: <b",
                    cat == "Procurement Category" ? ' style="text-shadow: 0 0 2px rgba(0, 0, 0, .8);color:' + extColor(d.nodeValue[cat]) + '"' : "",
                    ">",
                    d.nodeValue.procurement.category,
                    "</b><hr/>Region: <b>",
                    d.nodeValue.Region,
                    "</b><br/>Supplier: <b>",
                    d.nodeValue.supplier.name,
                    "</b><br/>Borrower: <b>",
                    d.nodeValue.borrower.name,
                    "</b><br/>Borrowed ($): <b>",
                    th(+d.nodeValue),
                    "M.</b><br/>"
                ];
            }

            tooltip.html(res.join(''));
            tooltip.style("display", "block");
        }
    }

    function moveToolTip(d, event) {
        event = event || d3.event;
        if (d && event) {
            tooltip
                .style("top", event.pageY > _h / 2 ? (event.pageY - tooltip.node().clientHeight - 16) + "px" : (event.pageY + 16) + "px")
                .style("left", event.pageX > _w / 2 ? (event.pageX - tooltip.node().clientWidth - 16) + "px" : (event.pageX + 16) + "px")
            ;
        }
        updateLegend();
    }

    function movem(d) {
        var item = arguments.length > 1 && arguments[1] instanceof HTMLCanvasElement ? arguments[1] : this;
        d = null;
        if (selected) {
            var od = selected;
            if (contain(od, d3.mouse(item)))
                d = od;
            if (!d) {
                od && (od.fixed &= 3);
                selected = null;
                d3.select("body").style("cursor", "default");
            }
        }
        else
            d = getNodeFromPos(d3.mouse(item));

        if (d) {
            selected = d;
            d.fixed |= 4;
            d3.select("body").style("cursor", "pointer");
        }
        showToolTip(d, d3.event);
        moveToolTip(d, d3.event);
    }


    function move() {
        lastEvent.translate = d3.event.translate.slice(0);
        lastEvent.scale = d3.event.scale;

        var tl = lastEvent.translate[0] / lastEvent.scale,
                tt = lastEvent.translate[1] / lastEvent.scale;

        xW.range([-tl, -tl + _w / lastEvent.scale])
                .domain([0, _w]);
        yH.range([-tt, -tt + _h / lastEvent.scale])
                .domain([0, _h]);

        valid = false;
    }

    vis.runShow = function(data, dom, w, h, asetting) {
        if (typeof _worker !== "undefined")
            clearTimeout(_worker);

        _data = data.sort(function(a, b) { return d3.ascending(a, b) });
        _w = w;
        _h = h;

        if (!_data || !_data.length)
            return;

        setting = asetting;

        extColor = d3.scale.category20();
        _parentKey = function(d) { return d.key; };
        _childKey = function(d) { return d.id; };

        dateRange = d3.extent(data, function(d) {
            return d.date;
        });

        layer = dom;
        layer.selectAll("*").remove();

        lastEvent = {
            translate: [0, 0],
            scale : 1
        };

        xW = d3.scale.linear()
                .range([0, w])
                .domain([0, w]);

        yH = d3.scale.linear()
                .range([0, h])
                .domain([0, h]);

        var zoom = d3.behavior.zoom()
                .scaleExtent([.1, 8])
                .scale(1)
                .translate([0, 0])
                .on("zoom", move);

        canvas = layer.append("canvas")
            .text("This browser don't support element type of Canvas.")
            .attr("id", "mainCanvas")
            .attr("width", w)
            .attr("height", h)
            .call(zoom)
            .node();

        tooltip = tooltip || d3.select(document.body).append("div").attr("class", "tooltip");
        tooltip.style("display", "none");

        ctx = canvas.getContext("2d");

        bufCanvas = document.createElement("canvas");
        bufCanvas.width = w;
        bufCanvas.height = h;

        bufCtx = bufCanvas.getContext("2d");
        bufCtx.globalCompositeOperation = 'lighter';

        bufCtx.font = "normal normal " + setting.sizeParent / 2 + "px Tahoma";
        bufCtx.textAlign = "center";

        d3.select(dom.node().parentNode).select("#s").remove();
        lHis = null;
        lCom = null;
        lLeg = null;

        layer = d3.select(dom.node().parentNode).append("div").attr("id", "s")
            .append("svg").attr('width', w).attr("height", h);

        layer.append("g")
            .call(setting.zoom ? setting.zoom : zoom)
            .on('mousemove.tooltip', movem)
            .append("rect")
            .attr("width", w)
            .attr("height", h)
            .attr("x", 0)
            .attr("y", 0)
            .style("fill", "#ffffff")
            .style("fill-opacity", 0);

        lHis && lHis.selectAll("*").remove();

        lCom = (
                lCom || layer.append("g")
                        .attr("width", 10)
                        .attr("height", 14)
                )
                .attr("transform", "translate(" + [w/2, h - 18] + ")")
        ;
        lCom.visible = !setting.showMessage;

        lCom.selectAll("text").remove();
        lCom.showMessage = lCom.showMessage || function(text) {
            if (setting.showMessage && !lCom.visible) {
                lCom.visible = true;
                lCom.style("display", null);
            }
            else if (!setting.showMessage && lCom.visible) {
                lCom.visible = false;
                lCom.style("display", "none");
            }

            if (!text)
                return;

            lCom.append("text")
                    .attr("text-anchor", "middle")
                    .attr("class", "com-mess")
                    .attr("transform", "translate("+ [0, -lCom.node().childElementCount * 14] +")")
                    .text(text.split("\n")[0].substr(0, 100))
                    .transition()
                    .delay(500)
                    .duration(2000)
                    .style("fill-opacity", 1)
                    .duration(200)
                    .style("font-size", "11.2pt")
                    .transition()
                    .duration(1500)
                    .style("fill-opacity", .3)
                    .style("font-size", "11pt")
                    .each("end", function() {
                        lCom.selectAll("text").each(function(d, i) {
                            d3.select(this)
                                    .attr("transform", "translate("+ [0, -i * 14] +")");
                        });
                    })
                    .remove();
        };

        vis.pb.show()
            .pos(0)
            .max(dateRange[1] - dateRange[0])
            .label(shortTimeFormat(dateRange[0]));

        links = d3.map({});
        regionLinks = [];
        nodes = initNodes(_data);

        _force = (_force || d3.layout.force()
                .stop()
                .size([w, h])
                .friction(.75)
                .gravity(0)
                //.charge(function(d) {return -1 * radius(nr(d)); } )
                .charge(-.5)
                .on("tick", tick))
                .nodes([])
        ;

        zoomScale = d3.scale.linear()
                .range([5, 1])
                .domain([.1, 1]);

        setting.padding = setting.padding || 0;
        _forceBase = (_forceBase || d3.layout.force()
            .stop()
            .size([w, h])
            //.linkDistance(setting.padding)
            .gravity(setting.padding * .001)
            .charge(function(d) {
                return setting.groupByRegion ? -(Math.pow(d.size, 2) + setting.padding * (d.links || 1)) : -(setting.padding + d.size) * 8;
            }))
            .nodes([])
        ;

        initLegend();

        stop = false;
        pause = false;

        run();
        _force.start();
        _forceBase.start();
    };

    vis.pauseShow = function() {
        pause = true;
    };

    vis.stopShow = function() {
        stop = true;
    };

    vis.resumeShow = function() {
        pause = false;
    };

    vis.resize = function(w, h) {
        _w = w;
        _h = h;
    }
})(vis || (vis = {}));

(function() {
    var w, h,
        _data,
        fy = 2013,
        div
    ;

    wbc.getByIsoId = function(id) {
        var c,
            l = wbc[1].length;
        while(--l > -1) {
            c = wbc[1][l];
            if (c.iso2Code == id)
                return c;
        }
        return null;
    };

    var countriesCounter = 0,
        countries = {},
        countryByIndex = [],
        failCountryCoord,
        needPaintCapital = [],
        projects
    ;

    function preload(d) {
        if (!d)
            return;
        d.img = new Image();
        d.img.onerror = (function(img) {
            return function() {
                console.log('error load url:' + d.img.src);
                d.img = null;
            }
        })(d);
        d.img.src = "https://dl-web.dropbox.com/spa/6x4vg7uwuzglgh3/wbgds/public/flags/" + d.key.toLowerCase() + '.png';
    }

    function coord(x, y) {
        var c = [x, y];
        return {
            x : {
                valueOf : function() {
                    var p = projection(c);
                    return p[0];
                }
            },
            y : {
                valueOf : function() {
                    var p = projection(c);
                    return p[1];
                }
            }
        }
    }

    // return object country
    function initCounty(key, value) {
        var c = countries[key] || ( countries[key] = {
            key: key,
            name: value,
            shortName: value.split(',')[0],
            borrowed : 0,
            supplied : 0,
            id: countriesCounter++,
            toString : function(full) {
                return full ? this.name : this.shortName;
            }
        });
        if (!countryByIndex[c.id]) {
            var cc = wbc.getByIsoId(c.key)
                ;
            if (!cc) {
                cc = failCountryCoord[c.key];
                if (!cc) {
                    cc = {
                        longitude : -50 + (10 * failCountryCoord.length++),
                        latitude : 80,
                        capitalCity : c.shortName
                    };
                    failCountryCoord[c.key] = cc;
                }
            }
            cc.init = true;
            c.capitalCity = {
                name : cc.capitalCity,
                coord : coord(cc.longitude, cc.latitude)
            };
            c.x = c.capitalCity.coord.x;
            c.y = c.capitalCity.coord.y;

            needPaintCapital.push(cc);

            // preload(c);
        }
        return countryByIndex[c.id] = c;
    }

    function initProcurement(d) {
        return {
            category : d['Procurement Category'],
            method : d['Procurement Method'],
            type : d['Procurement Type']
        };
    }

    function initContract(d) {
        return {
            desc : d['Contract Description'],
            date : Date.parse(d['Contract Signing Date'])
        };
    }

    function initProject(d) {
        return projects[d['Project ID']] || (projects[d['Project ID']] = {
            name : d['Project Name'],
            id : d['Project ID'],
            toString : function() {
                return this.name;
            }
        });
    }

    function value() {
        return this.basevalue || 0;
    }

    function initItem(d) {
        // Convert strings to numbers.
        d.value = d.basevalue = parseInt(d["Total Contract Amount (USD)"].substring(1));
        d.valueOf = value;

        d.borrower = initCounty(d["Borrower Country Code"], d["Borrower Country"]);
        d.borrower.borrowed += d.value;
        d.supplier = initCounty(d["Supplier Country Code"], d["Supplier Country"]);
        d.supplier.supplied += d.value;
        d.sector = d["Major Sector"];
        d.product = d['Product line'];
        d.procurement = initProcurement(d);
        d.contract = initContract(d);
        d.year = d['Fiscal Year'];
        d.project = initProject(d);
        d.id = d['WB Contract Number'] + d.project.id + d.supplier.key + d.borrower.key;
        d.date = d.contract.date;
        d.asdate = Date.parse(d['As of Date']);

        return d;
    }

    function clone(d) {
        var newItem = {};

        for (var key in d) {
            if (!d.hasOwnProperty(key))
                continue;
            newItem[key] = d[key];
        }
        return newItem;
    }

    function sortByCSD(a, b) {
        return b.contract.date - a.contract.date;
    }

    var sizes = d3.scale.linear()
        .range([4, 400]);

    var projection = d3.geo.mercator();

    var path = d3.geo.path()
        .projection(projection);

    function ctr(d) {
        return "translate(" + projection([d.longitude, d.latitude]) + ")";
    }

    var zoom = d3.behavior.zoom()
        .on("zoom", function() {
            projection.translate(d3.event.translate).scale(d3.event.scale);
            feature.attr("d", path);
            circle.attr("transform", ctr);
        })
        ;

    var fsvg = d3.select(document.body)
            .append("div")
            .attr("id", "map")
            .append("svg");

    var feature = fsvg
            .selectAll("path.feature");

    var circle;

    function request(error, data) {
        var l, a, b;
        projects = {};
        countriesCounter = 0;
        countries = {};
        countryByIndex = [];
        failCountryCoord = {length : 0};
        needPaintCapital = [];

        data = data.map(initItem);
        l = data.length;
        sizes.domain(d3.extent(data));

        _data = [];
        while(--l > -1) {
            a = data[l];
            a.size = sizes(+a);
            b = clone(a);
            a.parent = a.supplier;
            b.parent = b.borrower;
            a.date = a.date - stepDate /*/2*/;
            _data.push(a);
            _data.push(b);
        }
        _data.sort(sortByCSD);

        div = div || d3.select(document.body).append("div").attr("id", "c");
        w = document.body.clientWidth;
        h = document.body.clientHeight;

        projection
            .scale(w/6.5)
            .translate([w / 2, h / 1.6])
        ;

        zoom.translate(projection.translate())
            .scale(projection.scale())
            .scaleExtent([h / 6, h])
        ;

        feature.attr("d", path);

        fsvg.selectAll("circle").remove();

        circle = fsvg.selectAll("circle")
            .data(needPaintCapital)
            .enter()
            .append("circle")
            .attr("r", 1)
            .attr("fill", "#fff")
            .attr("transform", ctr);

        vis.pb = vis.pb || (
            d3.select(document.body)
                .append("div")
                .attr("id", "pb")
                .style("height", "18px")
                .append("svg")
                .attr("width", w)
                .attr("height", 18)
                .append("g")
                .call(d3.helper.progressbar)
        );

        vis.pb.width(w).height(18).textPosition("middle").max(0);

        imgPreloader.hide();

        setting.zoom = zoom;

        vis.runShow(_data, div, w, h, setting);
        btnPause.show();
        btnStop.show();
        //vis.stopShow();
    }

    d3.select("#chHisto").on("change", function(d) {
        setting.showHistogram = this.checked;
    });

    d3.select("#chLeg").on("change", function(d) {
        setting.showCountExt = this.checked;
    });

    d3.select("#chEdge").on("change", function(d) {
        setting.showEdge = this.checked;
    });

    d3.select("#chTrack").on("change", function(d) {
        setting.showTrack = this.checked;
    });

    d3.select("#chTail").on("change", function(d) {
        setting.fadingTail = this.checked;
    });

    d3.select("#fs").attr("href", document.location);

    var imgPreloader = d3.select("#imgPreloader"),
        btnStart = d3.select("#btnStart").on('click', function() {
            vis.resumeShow();
            btnRestart.hide();
            btnStart.hide();
            btnPause.show();
            btnStop.show();
        }),
        btnRestart = d3.select("#btnRestart").on('click', function() {
            vis.stopShow();
            btnRestart.hide();
            btnStart.hide();
            btnPause.show();
            btnStop.show();
            vis.runShow(_data, div, w, h, setting);
        }),
        btnPause = d3.select("#btnPause").on('click', function() {
            vis.pauseShow();
            btnRestart.hide();
            btnPause.hide();
            btnStart.show();
        }),
        btnStop = d3.select("#btnStop").on('click', function() {
            vis.stopShow();
            btnRestart.show();
            btnPause.hide();
            btnStart.hide();
            btnStop.hide();
        }),
        btnReload = d3.select("#btnReload").on('click', function() {
            vis.stopShow();
            btnRestart.hide();
            btnReload.hide();
            btnStart.hide();
            btnPause.hide();
            btnStart.hide();
            imgPreloader.show();
            d3.csv(fy + '.csv', request);
        })
    ;

    [btnStart, btnRestart,
     btnPause, btnStop,
     btnReload, imgPreloader].forEach(function(d) {
        d.hide = function() {
            d.style("display", "none");
        };
        d.show = function() {
            d.style("display", null);
        };
    });

    btnPause.hide();
    btnStop.hide();

    d3.select("#typeParam")
        .on("change", function(d) {
            cat = this.value;
            btnRestart.show();
        })
        .selectAll('option')
        .data([
            "Major Sector",
            "Procurement Category",
            "Procurement Method",
            "Procurement Type",
            "Product line"
        ])
        .enter()
        .append("option")
        .attr("selected", function(d) { return d == cat ? "selected" : null; })
        .attr("value", function(d) { return d; })
        .text(function(d) { return d; })
    ;

    var param;
    if (document.location.hash && document.location.hash.indexOf('year') > -1) {
        param = {};
        document.location.hash.replace("#", "")
            .split('&').forEach(function(d) {
                d = d.split('=');
                param[d[0]] = d[1];
            });
        fy = +param.year;
    }

    d3.select("#fiscalYear")
        .on("change", function(d) {
            fy = +this.value;
            if (document.location.href.indexOf('visualizing.org') > -1)
                document.location = "http://artzub.com/d3/wbca/#year=" + fy;
            btnReload.show();
        })
        .selectAll('option')
        .data([2007, 2008, 2009, 2010, 2011, 2012, 2013])
        .enter()
        .append("option")
        .attr("selected", function(d) { return d == fy ? "selected" : null; })
        .attr("value", function(d) { return d; })
        .text(function(d) { return d; })
    ;

    imgPreloader.show();

    d3.json(document.location.href.indexOf('visualizing.org') > -1
        ? "/sites/default/files/sprint/data/world-countries.json"
        : "world-countries.json", function (error, collection) {

        feature = feature
            .data(collection.features)
            .enter().append("path")
            .attr("class", "feature")
        ;

/*            .on("mouseover", overpath)
            .on("mousemove", moverpath)
        //.on("click", clickPath)
            .on("mouseout", outpath)
*/
        if (document.location.href.indexOf('visualizing.org') > -1)
            d3.csv("/sites/default/files/data_set/admin/sprint_major-contract-awards-2013.csv", request);
        else
            d3.csv(fy + '.csv', request);            
    });

})();

</script>