<!DOCTYPE html>
<html>
<head>
    <title>Mapa {{ title }}</title>
    <script src="/javascripts/jquery-2.1.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <link rel="stylesheet" href="/stylesheets/foundation.css" />

	<link rel="stylesheet" href='/stylesheets/font-awesome.min.css'>

    <link rel='stylesheet' href='/stylesheets/style.css' />

    <script src="/javascripts/d3.v3.min.js"></script>
    <script src="/javascripts/topojson.v1.min.js"></script>
    <script src="/javascripts/datamaps.world.min.js"></script>

    <script charset="utf-8" src="https://rawgithub.com/artzub/dbsv/master/progressbar.js"></script>
    <script charset="utf-8" src="https://rawgithub.com/artzub/dbsv/master/tooltip.js"></script>
    <script charset="utf-8" src="https://rawgithub.com/artzub/wbgds/smy/wbc.js"></script>

    <script>
        var socket = io.connect();

        var latitudes = [ { "x": 18.4583254, "y": -97.4843226},
            { "x": 30.9871264, "y": -110.2839651},
            { "x": 29.0784761, "y": -110.9793706},
            { "x": 24.1164679, "y": -110.3032952},
            { "x": 23.2467867, "y": -106.4221208},
            { "x": 24.0289606, "y": -104.645293},
            { "x": 21.8890872, "y": -102.2919885}
        ];

        socket.on('connect', function() {
            console.log('Conectado - página 1!');
        });

        socket.on('disconnect', function() {
            console.log('disconnected');
            // content.html("<b>Disconnected!</b>");
        });

        var map = {};

        $(document).ready(function() {
            var socket = io.connect();
            var content = $('#filas');

            var fechaactual = null;

            socket.on('connect', function() {
                console.log('Conectado - página 1!');
            });

            map = new Datamap({
            	    	element: document.getElementById('mapContainer'),
            	    	projection: 'mercator',
            	    	scope: 'world',
            	    	geographyConfig: {
        	    		borderWidth: 0,
                        hideAntarctica: true,
                        popupOnHover: false,
                        highlightOnHover: false,
                        highlightBorderWidth: 0
        	    	},

            	    	fills: {
        		        'PDM': 'rgba(241,90,36,0.8)',
                		        defaultFill: 'rgba(255,255,255,0.2)',
                        'BLU': 'rgba(141,30,56,0.7)',
                                defaultFill: 'rgba(0,0,0,0.2)'
        	    	}
    		});

//            console.log('Hola!');
//            bubbles(dataEntrada);
//            console.log('Adios!');

        });

        //Aquí pasa la magia

        //Datos de prueba
        var dataEntrada = [{
            amount: 90,
            x: 120,
            y: 140,
            country: "MX"
        }, {
            amount: 200,
            x: 320,
            y: 90,
            country: "MX"
        }, {
            amount: 340,
            x: 20,
            y: 300,
            country: "MX"
        }, {
            amount: 600,
            x: 300,
            y: 30,
            country: "MX"
        }, {
            amount: 140,
            x: 220,
            y: 40,
            country: "MX"
        }, {
            amount: 100,
            x: 10,
            y: 200,
            country: "MX"
        }, {
            amount: 400,
            x: 40,
            y: 300,
            country: "MX"
        }, {
            amount: 140,
            x: 50,
            y: 400,
            country: "MX"
        }, {
            amount: 500,
            x: 300,
            y: 10,
            country: "MX"
        }];

        function bubbles(datos) {

            //Tamaño del contenedor TODO hacerlo del tamaño del mapa
            var w = $('.datamap').width();
            var h = $('.datamap').height();

            console.log(datos);

            var svg = d3.select(".datamap")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

            var bubble = svg.selectAll("g")
                    .data(datos);

            var gBubble = bubble.enter()
                    .append("g")
                    .attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")"
                    });

            var pulse = gBubble.append("circle")
                    .attr("r", 0)
                    .attr("fill", "rgba(235,113,60,0.6")
                    .attr("stroke", "rgba(235,113,60,0.9)")
                    .attr("stroke-width", 0)
                    .attr("stroke-dasharray", "1,0");
            var mini = gBubble.append("circle")
                    .attr("r", 4)
                    .attr("fill", "rgba(235,113,60,0");
            mini.transition()
                    .duration(1000)
                    .delay(function (d, i) {
                        return i * 200;
                    })
                    .attr("fill", "rgba(235,113,60,0.8")
                    .each("end", function () {
                        d3.select(this)
                    })
                    .remove();

            pulse.transition()
                    .duration(1600)
                    .delay(function (d, i) {
                        return i * 200;
                    })
                    .ease("bounce")
                    .each("start", function () {
                        d3.select(this)
                                .attr("fill", "rgba(235,113,60,0.2")
                                .attr("opacity", 1);
                    })
                    .attr("r", 6)
                    .each("end", function () {
                        d3.select(this)

                    })
                    .attr("stroke-width", 2)
                    .attr("stroke", "rgba(235,113,60,0.4)")
                    .attr("stroke-dasharray", "2,2")
                    .attr("fill", "rgba(235,113,60,0")
                    .attr("r", function (d) {
                        return d.amount / 5;
                    })
                    .attr("opacity", 0.4)
                    .remove();
        }

        socket.on('message', function(message){

            // console.log(message);

            if ((message.indexOf('"canal_mensaje":"pademobile_log_transaccion"') == -1)) {
                return 0;
            }

            var datos = JSON.parse(message);

            var pais = '{{ pais }}'.toUpperCase();

            switch(datos.canal_mensaje) {
                case 'pademobile_log_transaccion' :

                    var item = latitudes[Math.floor(Math.random()*latitudes.length)];

                    var radio = datos.importe;

                    if (radio == null ) {
                        radio = 50;
                        var color = 'BLU';
                    } else {
                        radio = Math.abs(datos.importe);
                        var color = 'PDM';
                    }

                    var posicion = map.latLngToXY(item.x, item.y);

                    // console.log(posicion);

                    // console.log(radio);

                    var datos = [ {
                        amount: radio,
                        x: posicion[0],
                        y: posicion[1]
                        //country: "MX"
                     }];

                    bubbles(datos);

//                    var transactions = [{
//                        radius: radio,
//                        borderColor: 'rgba(241,90,36,0.8)',
//                        borderWidth: 1,
//                        latitude: item.x,
//                        longitude: item.y
//                    }];
//
//                    map.bubbles(transactions,{
//                        highlightOnHover: false,
//                        popupOnHover: false
//                    });
//                    break;
            }
        }) ;
    </script>
</head>

<body>
    <div id="mapContainer" class="mapView"></div>

    <div class="bottomLine marquee">
        <div>
        <section>
            <span class="barTitle">Transactions</span>
            <span class="barElement">MEX 12,181 <span class="greenSign fa fa-arrow-up"></span></span>
            <span class="barElement">ESP 1,238 <span class="redSign fa fa-arrow-down"></span></span>
            <span class="barElement">USA 902 <span class="greenSign fa fa-arrow-up"></span></span>
            <span class="barElement">ITA 902 <span class="greenSign fa fa-arrow-up"></span></span>

            <span class="barTitle">Top Users MEX</span>
            <span class="barElement">dgsalas</span>
            <span class="barElement">diego_</span>
            <span class="barElement">4492019221</span>

            <span class="barTitle">Top Users USA</span>
            <span class="barElement">1331292828</span>
            <span class="barElement">1291822384</span>
            <span class="barElement">1492019221</span>

        </section>

        <section>
            <span class="barTitle">Transactions</span>
            <span class="barElement">MEX 12,181 <span class="greenSign fa fa-arrow-up"></span></span>
            <span class="barElement">ESP 1,238 <span class="redSign fa fa-arrow-down"></span></span>
            <span class="barElement">USA 902 <span class="greenSign fa fa-arrow-up"></span></span>
            <span class="barElement">ITA 902 <span class="greenSign fa fa-arrow-up"></span></span>

            <span class="barTitle">Top Users MEX</span>
            <span class="barElement">dgsalas</span>
            <span class="barElement">diego_</span>
            <span class="barElement">4492019221</span>

            <span class="barTitle">Top Users USA</span>
            <span class="barElement">1331292828</span>
            <span class="barElement">1291822384</span>
            <span class="barElement">1492019221</span>

        </section>

        </div>
    </div>

    <img class="poweredby" src="images/poweredby.svg">
</body>