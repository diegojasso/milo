<!DOCTYPE html>
<html>
<head>
    <title>Log en tiempo real {{ pais }}</title>
    <script src="/javascripts/jquery-2.1.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <link rel="stylesheet" href="/stylesheets/foundation.css" />

    <link rel="stylesheet" href='/stylesheets/font-awesome.min.css'>

    <link rel="stylesheet" href='/stylesheets/resizableColumns.css'>

    <link rel='stylesheet' href='/stylesheets/style.css' />

    <!-- Latest compiled and minified JavaScript -->

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>

    <script src="/javascripts/moment.min.js"></script>
    <script src="/javascripts/money.min.js"></script>
    <script src="/javascripts/accounting.min.js"></script>

    <script src="/javascripts/jquery.dataTables.min.js"></script>


    <script>
        Number.prototype.formatMoney = function(pais){

            switch (pais) {
                case 'MX' :
                    var divisa_pais = 'MXN';
                    break;
                case 'ES' :
                    var divisa_pais = 'EUR';
                    break;
                default:
                    var divisa_pais = 'USD';
            }

            return accounting.formatMoney(this, {
                symbol: divisa_pais,
                format: "%v %s"
            });
        };

        $(document).ready(function() {

            var wHeight = $(window).height() - 100;
            var socket = io.connect();
            var content = $('#filas');

            socket.on('connect', function() {
                console.log('Conectado - página 1!');
            });

            socket.on('message', function(message){

                console.log(message);

                if ((message.indexOf('"canal_mensaje":"pademobile_log_total"') == -1) &&
                    (message.indexOf('"canal_mensaje":"pademobile_log_transaccion"') == -1)) {
                    return 0;
                }

                var datos = JSON.parse(message);

                var pais = '{{ pais }}'.toUpperCase();

                switch(datos.canal_mensaje) {
                    case 'pademobile_log_total' :
                        // console.log(datos);
                        if (pais == '') {
                            $('#transacciones').html(datos.datos.transacciones);
                            $('#importe').html(datos.datos.importe.formatMoney(pais));
                            $('#comisiones').html(datos.datos.comisiones.formatMoney(pais));
                            $('#transacciones_completadas').html(datos.datos.transacciones_conimporte);
                        } else {
                            if (datos.datos[pais] == null) {
                                var cero = 0;
                                $('#transacciones').html(cero);
                                $('#importe').html(cero.formatMoney(pais));
                                $('#comisiones').html(cero.formatMoney(pais));
                                $('#transacciones_completadas').html(cero);
                            } else {
                                $('#transacciones').html(datos.datos[pais].transacciones);
                                $('#importe').html(datos.datos[pais].importe.formatMoney(pais));
                                $('#comisiones').html(datos.datos[pais].comisiones.formatMoney(pais));
                                $('#transacciones_completadas').html(datos.datos[pais].transacciones_conimporte);
                            }
                        }

                        break;

                    case 'pademobile_log_transaccion' :

                        if ((pais == datos.pais) || (pais == '')) {

                            var statusIcon;
                            var destinoSub;
                            var idTran = datos.codtran;
                            var idSubs = idTran.substring(22, 33);

                            var dateOrig = datos.fecha;
                            var dateSubs = dateOrig.substring(11, 20);

                            var fila = $('#' + datos.codtran);

                            var t = $('#tabla').DataTable({
                                "order":            [1, "desc"],
                                "info":             false,
                                "paging":           false,
                                "retrieve":         true,
                                "searching":        false,
                                "scrollY":          wHeight,
                                "scrollCollapse":   true     
                            });

                            if (datos.estado == '1') 
                                statusIcon = '<i class="greenSign fa fa-check-circle statusIcon"></i>'
                            else if (datos.estado == '-3') 
                                statusIcon = '<span class="helperP"><i class="redSign fa fa-times-circle statusIcon"></i><span class="except">' + datos.excepcion +'</span></span>'
                            else if (datos.estado == '-2')
                                statusIcon = '<span class="helperP"><i class="redSign fa fa-times-circle statusIcon"></i><span class="except">' + datos.excepcion +'</span></span>'
                            else if (datos.estado == '-1')
                                statusIcon = '<i class="yellowSign fa fa-exclamation-circle statusIcon"></i>'
                            else if (datos.estado == '0')
                                statusIcon = '<i class="yellowSign fa fa-question-circle statusIcon"></i>'
                            else
                                statusIcon = '<i class="yellowSign fa fa-check-circle statusIcon"></i>'

                            if (datos.destino)
                                destinoSub = '<span>' + datos.destino.alias + '</span>'
                            else
                                destinoSub = '<span> (None) </span>'

                            var tranHelper;

                            tranHelper = '<span class="helperP">…'+ idSubs +'&#8203;<span class="helperItem">' + datos.codtran +'</span></span>';

                            if (fila.length != 0) {
                                console.log('Reemplazamos la fila '+fila);
                                t.row(fila).data([
                                    statusIcon,
                                    dateSubs,
                                    datos.canal,
                                    datos.nombre_accion,
                                    datos.usuario.alias,
                                    datos.importe_fmt_abs,
                                    destinoSub,
                                    datos.concepto,
                                    tranHelper
                                ]);
                            } else {
                                t.row.add( {
                                        "0": statusIcon,
                                        "1": dateSubs,
                                        "2": datos.canal,
                                        "3": datos.nombre_accion,
                                        "4": datos.usuario.alias,
                                        "5": datos.importe_fmt_abs,
                                        "6": destinoSub,
                                        "7": datos.concepto,
                                        "8": tranHelper,
                                        "DT_RowId": datos.codtran }
                                ).draw()
                                .$();
                            }

                            $(t).fadeOut(300).fadeIn(300);
                        }

                        break;
                }
            }) ;

            socket.on('disconnect', function() {
                console.log('disconnected');
                // content.html("<b>Disconnected!</b>");
            });

        });
    </script>
</head>
<body>
  <div class="row tableLog">
    <div id="wrapper" class="large-9 columns">
      <div id="filas">
          <table id="tabla" class="ofScroll">
              <thead>
              <tr>
                  <th class="state_col">State</th>
                  <th class="date_col">Date</th>
                  <th class="channel_col">Channel</th>
                  <th class="service_col">Service</th>
                  <th class="userName_col">From</th>
                  <th class="">Amount</th>
                  <th class="">To</th>
                  <th class="">Subject</th>
                  <th class="">ID</th>
              </tr>
              </thead>
              <tbody>

              </tbody>
          </table>
      </div>

    </div>
    <div class="total_izquierda large-3 columns">
        <div class="rightWidget">
        <div class="rwCell">
          <h1 id="importe">0</h1>
          <span class="titulo_total">MANAGED AMOUNT</span>            
        </div>
         </div> 
        <div class="rightWidget">
        <div class="rwCell">
          <h1 id="transacciones">0</h1>
          <span class="titulo_total">TRANSACTIONS</span>
        </div>
        </div>
        <div class="rightWidget">
        <div class="rwCell">
          <h1 id="comisiones">0</h1>
          <span class="titulo_total">TOTAL FEES</span>
        </div>
        </div> 
        <div class="rightWidget">
        <div class="rwCell">
          <h1 id="transacciones_completadas">0</h1>
          <span class="titulo_total">MONEY TRANSACTIONS</span>
        </div>
        </div>
    </div>
  </div>
</body>